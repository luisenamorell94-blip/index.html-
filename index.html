<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comercial GYG - Sistema Integrado</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { 
            --primary: #004d40;    /* Verde Oficina */
            --field-color: #e65100; /* Naranja Campo */
            --contado: #4a148c;     /* Morado Contado */
            --abonos: #1565c0;      /* Azul Abonos */
            --faltante: #c62828;    /* Rojo Faltantes */
            --excedente: #00838f;   /* TURQUESA EXCEDENTE (NUEVO) */
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; padding-bottom: 80px;}
        
        /* HEADER */
        header { background-color: var(--primary); color: white; padding: 10px; text-align: center; border-radius: 0 0 8px 8px; margin-bottom: 15px; }
        
        .container { max-width: 950px; margin: 0 auto; }
        
        /* PESTA√ëAS (SCROLL HORIZONTAL) */
        .tabs { display: flex; cursor: pointer; gap: 5px; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .tab { flex: 1; min-width: 100px; padding: 12px; text-align: center; font-weight: bold; background: #ccc; color: #555; border-radius: 8px 8px 0 0; transition: 0.2s; font-size: 0.85rem; }
        
        .tab.active-oficina { background: white; color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab.active-campo { background: white; color: var(--field-color); border-bottom: 3px solid var(--field-color); }
        .tab.active-contado { background: white; color: var(--contado); border-bottom: 3px solid var(--contado); }
        .tab.active-abonos { background: white; color: var(--abonos); border-bottom: 3px solid var(--abonos); }
        .tab.active-faltantes { background: white; color: var(--faltante); border-bottom: 3px solid var(--faltante); }
        .tab.active-excedente { background: white; color: var(--excedente); border-bottom: 3px solid var(--excedente); }

        /* CARD FORMULARIO */
        .card { background: white; padding: 15px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .full-width { grid-column: span 2; }
        
        label { display: block; font-size: 0.8rem; font-weight: bold; color: #555; margin-bottom: 4px; margin-top: 8px; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* BOTONES PRINCIPALES */
        .btn-group { margin-top: 15px; display: flex; gap: 10px; }
        button.main-btn { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; color: white; cursor: pointer; font-size: 1rem; }
        
        .btn-oficina { background-color: var(--primary); }
        .btn-campo { background-color: var(--field-color); }
        .btn-contado { background-color: var(--contado); }
        .btn-abonos { background-color: var(--abonos); }
        .btn-faltantes { background-color: var(--faltante); }
        .btn-excedente { background-color: var(--excedente); }
        
        .btn-cancelar { background-color: #616161; display: none; margin-bottom: 10px; width: 100%; padding: 10px; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* ESTILOS DE TABLA */
        .report-section { background: white; border-radius: 8px; padding: 10px; margin-bottom: 15px; border-top: 5px solid #555; box-shadow: 0 1px 3px rgba(0,0,0,0.1); page-break-inside: avoid; }
        
        .border-david { border-top-color: #1565c0; }
        .border-lesly { border-top-color: #ad1457; }
        .border-mix { border-top-color: #6a1b9a; }
        .border-jose { border-top-color: #2e7d32; }
        .border-abonos { border-top-color: #1565c0; }
        .border-faltantes { border-top-color: #c62828; }
        
        .account-title { margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 1rem; color: #333; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 8px 5px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { background-color: #fafafa; color: #666; font-weight: bold; }
        
        .btn-action { border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-left: 2px; }
        .btn-edit { background: #e3f2fd; color: #1565c0; }
        .btn-del { background: #ffebee; color: #c62828; }

        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: white; font-weight: bold; }
        .bg-oficina { background: var(--primary); }
        .bg-campo { background: var(--field-color); }

        .zone-summary { background: #f9f9f9; padding: 8px; margin-top: 8px; font-size: 0.8rem; border-radius: 4px; }
        .zone-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #ddd; padding: 2px 0; }
        
        .grand-total { background: #333; color: white; padding: 10px; text-align: right; font-weight: bold; font-size: 1.2rem; border-radius: 5px; margin-top: 15px; }

        .hidden { display: none; }
        .btn-pdf { width: 100%; background: #d32f2f; color: white; padding: 15px; border: none; font-weight: bold; margin-top: 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; }

        @media print {
            .no-print, .tabs, .card, header { display: none !important; }
            body { background: white; }
            .grand-total { background: #333 !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<header class="no-print">
    <h2 style="margin:0;">SISTEMA GYG</h2>
</header>

<div class="container">

    <div class="tabs no-print">
        <div class="tab active-oficina" id="tab-oficina" onclick="cambiarModo('OFICINA')">üè¢ OFICINA</div>
        <div class="tab" id="tab-campo" onclick="cambiarModo('CAMPO')">üèçÔ∏è CAMPO</div>
        <div class="tab" id="tab-contado" onclick="cambiarModo('CONTADO')">üì¶ CONTADO</div>
        <div class="tab" id="tab-abonos" onclick="cambiarModo('ABONOS')">üí∞ ABONOS</div>
        <div class="tab" id="tab-faltantes" onclick="cambiarModo('FALTANTES')">‚ö†Ô∏è FALTANTES</div>
        <div class="tab" id="tab-excedente" onclick="cambiarModo('EXCEDENTE')">üí≥ EXCEDENTE</div>
    </div>

    <div class="card no-print">
        <div class="form-grid">
            <div class="full-width">
                <label>Fecha:</label>
                <input type="date" id="fecha">
            </div>

            <div id="bloque-depositos" class="full-width form-grid" style="margin:0; padding:0; gap:10px;">
                <div>
                    <label>Semana:</label>
                    <select id="semana"><option>Semana 1</option><option>Semana 2</option><option>Semana 3</option><option>Semana 4</option><option>Semana 5</option></select>
                </div>
                <div>
                    <label>Referencia:</label>
                    <input type="number" id="referencia" placeholder="Ref.">
                </div>
                <div class="full-width">
                    <label>Zona:</label>
                    <select id="zona" onchange="autoCobrador()"></select>
                </div>
                <div class="full-width">
                    <label>Cobrador:</label>
                    <input type="text" id="cobrador" readonly style="background:#eee;">
                </div>
                <div class="full-width">
                    <label>Cuenta Destino:</label>
                    <select id="cuenta"></select>
                </div>
            </div>

            <div id="bloque-contado" class="full-width form-grid hidden" style="margin:0; padding:0; gap:10px;">
                <div>
                    <label>Vendedor:</label>
                    <select id="vendedor">
                        <option value="">-- Seleccione --</option>
                        <option value="SANTOS">Santos</option>
                        <option value="NOE">No√©</option>
                        <option value="CARLOS">Carlos</option>
                        <option value="RAMON">Ram√≥n</option>
                        <option value="ORLANDO">Orlando</option>
                        <option value="DAVID">David</option>
                    </select>
                </div>
                <div>
                    <label>Cuenta Destino:</label>
                    <select id="contado_cuenta"></select>
                </div>
                <div class="full-width">
                    <label>Art√≠culo:</label>
                    <input type="text" id="articulo" placeholder="Descripci√≥n del art√≠culo">
                </div>
            </div>

            <div id="bloque-abonos" class="full-width form-grid hidden" style="margin:0; padding:0; gap:10px;">
                <div>
                    <label>N¬∞ Tarjeta:</label>
                    <input type="text" id="abono_tarjeta" placeholder="Manual">
                </div>
                <div>
                    <label>Art√≠culo:</label>
                    <input type="text" id="abono_articulo" placeholder="Manual">
                </div>
                <div>
                    <label>Saldo Restante:</label>
                    <input type="number" id="abono_saldo" placeholder="L. 0.00">
                </div>
                <div>
                    <label>Cuenta Destino:</label>
                    <select id="abono_cuenta"></select>
                </div>
            </div>

            <div id="bloque-faltantes" class="full-width form-grid hidden" style="margin:0; padding:0; gap:10px;">
                <div class="full-width">
                    <label>Cobrador (Seleccione primero):</label>
                    <select id="faltante_cobrador" onchange="actualizarZonasFaltante()">
                        <option value="">-- Seleccione --</option>
                        <option value="MIGUEL">MIGUEL</option>
                        <option value="ANGEL">ANGEL</option>
                        <option value="FERNANDO">FERNANDO</option>
                        <option value="AMALET">AMALET</option>
                        <option value="JORGE">JORGE</option>
                    </select>
                </div>
                <div class="full-width">
                    <label>Zona del Faltante:</label>
                    <select id="faltante_zona">
                        <option value="">-- Seleccione Cobrador Primero --</option>
                    </select>
                </div>
            </div>

            <div id="bloque-excedente" class="full-width form-grid hidden" style="margin:0; padding:0; gap:10px;">
                <div>
                    <label>N¬∞ Tarjeta:</label>
                    <input type="text" id="exc_tarjeta" placeholder="Manual">
                </div>
                <div>
                    <label>Art√≠culo:</label>
                    <input type="text" id="exc_articulo" placeholder="Manual">
                </div>
                <div class="full-width">
                    <label style="color:var(--excedente);">Cuenta Destino:</label>
                    <input type="text" value="CUENTA LESLY" readonly style="background:#e0f7fa; color:var(--excedente); font-weight:bold; border:1px solid var(--excedente);">
                </div>
            </div>

            <div class="full-width">
                <label id="lbl-monto">Monto (L.):</label>
                <input type="number" id="monto" placeholder="0.00" style="font-size:1.1rem; font-weight:bold;">
            </div>
        </div>

        <button id="btn-cancelar" class="btn-cancelar" onclick="cancelar()">CANCELAR EDICI√ìN</button>
        <button id="btn-guardar" class="main-btn btn-oficina" onclick="guardar()">GUARDAR REGISTRO</button>
    </div>

    <div id="area-impresion">
        <h3 class="no-print" style="margin-top:0; border-bottom:1px solid #ccc;">Reporte Actual</h3>
        <div id="contenedor-reportes"></div>
        <div class="grand-total">TOTAL GLOBAL: <span id="total-global">L. 0.00</span></div>
    </div>

    <button onclick="window.print()" class="btn-pdf no-print">üìÑ GENERAR PDF / IMPRIMIR</button>

</div>

<script>
    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAYJRmMQbV-j6hGfHCZyuCgtvmkY0C2L1g",
      authDomain: "ingreso-depositos.firebaseapp.com",
      databaseURL: "https://ingreso-depositos-default-rtdb.firebaseio.com",
      projectId: "ingreso-depositos",
      storageBucket: "ingreso-depositos.firebasestorage.app",
      messagingSenderId: "788432921819",
      appId: "1:788432921819:web:b5f792eecbe4b7b00498fe"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- VARIABLES ---
    let MODO = 'OFICINA';
    let ID_EDITANDO = null;
    let listaDep = [];
    let listaCon = [];
    let listaAbo = [];
    let listaFal = [];
    let listaExc = []; // Excedentes

    const rutas = {
        "MIGUEL": ["Elixir", "Saba Olanchito", "Zona Saba"],
        "ANGEL": ["Margen Izquierda", "Saba Tocoa"],
        "FERNANDO": ["Vicinia", "Trujillo", "Honduras Aguan"],
        "AMALET": ["Balfate", "Bonito Oriental"],
        "JORGE": ["Planes", "Jutiapa", "Sonaguera", "Faust"]
    };

    const configCuentas = {
        "DAVID": { t: "CUENTA DAVID", c: "border-david" },
        "LESLY": { t: "CUENTA LESLY", c: "border-lesly" },
        "DAVID_LESLY": { t: "DAVID (VIA LESLY)", c: "border-mix" },
        "JOSE_RODINDER": { t: "JOSE RODINDER", c: "border-jose" }
    };

    // --- INICIO ---
    window.onload = function() {
        document.getElementById('fecha').valueAsDate = new Date();
        llenarZonas();
        actualizarCuentas();
        llenarCuentasExtra();

        // Listeners
        db.ref('registros_milagro').on('value', snap => {
            listaDep = []; if(snap.val()) Object.keys(snap.val()).forEach(k => listaDep.push({id:k, ...snap.val()[k]})); pintarReportes();
        });
        db.ref('ventas_contado').on('value', snap => {
            listaCon = []; if(snap.val()) Object.keys(snap.val()).forEach(k => listaCon.push({id:k, ...snap.val()[k]})); pintarReportes();
        });
        db.ref('abonos_clientes').on('value', snap => {
            listaAbo = []; if(snap.val()) Object.keys(snap.val()).forEach(k => listaAbo.push({id:k, ...snap.val()[k]})); pintarReportes();
        });
        db.ref('faltantes_cobro').on('value', snap => {
            listaFal = []; if(snap.val()) Object.keys(snap.val()).forEach(k => listaFal.push({id:k, ...snap.val()[k]})); pintarReportes();
        });
        db.ref('excedente_tarjetas').on('value', snap => {
            listaExc = []; if(snap.val()) Object.keys(snap.val()).forEach(k => listaExc.push({id:k, ...snap.val()[k]})); pintarReportes();
        });
    };

    // --- PESTA√ëAS ---
    window.cambiarModo = function(modo) {
        MODO = modo;
        cancelar(); 

        // Reset Styles
        ['oficina','campo','contado','abonos','faltantes','excedente'].forEach(m => {
            document.getElementById('tab-'+m).className = 'tab';
            let bloqueId = (m === 'oficina' || m === 'campo') ? 'depositos' : m;
            document.getElementById('bloque-'+bloqueId).classList.add('hidden');
        });

        const btn = document.getElementById('btn-guardar');
        const lblMonto = document.getElementById('lbl-monto');

        document.getElementById('tab-' + modo.toLowerCase()).className = 'tab active-' + modo.toLowerCase();
        
        if(modo === 'OFICINA') {
            document.getElementById('bloque-depositos').classList.remove('hidden');
            btn.className = 'main-btn btn-oficina'; btn.innerText = "GUARDAR (OFICINA)";
            lblMonto.innerText = "Monto Dep√≥sito (L.):";
        } else if(modo === 'CAMPO') {
            document.getElementById('bloque-depositos').classList.remove('hidden');
            btn.className = 'main-btn btn-campo'; btn.innerText = "GUARDAR (CAMPO)";
            lblMonto.innerText = "Monto Dep√≥sito (L.):";
        } else if(modo === 'CONTADO') {
            document.getElementById('bloque-contado').classList.remove('hidden');
            btn.className = 'main-btn btn-contado'; btn.innerText = "GUARDAR VENTA CONTADO";
            lblMonto.innerText = "Saldo Contado (L.):";
        } else if(modo === 'ABONOS') {
            document.getElementById('bloque-abonos').classList.remove('hidden');
            btn.className = 'main-btn btn-abonos'; btn.innerText = "GUARDAR ABONO";
            lblMonto.innerText = "Monto Abonado (L.):";
        } else if(modo === 'FALTANTES') {
            document.getElementById('bloque-faltantes').classList.remove('hidden');
            btn.className = 'main-btn btn-faltantes'; btn.innerText = "GUARDAR FALTANTE";
            lblMonto.innerText = "Monto Faltante (L.):";
        } else { // EXCEDENTE
            document.getElementById('bloque-excedente').classList.remove('hidden');
            btn.className = 'main-btn btn-excedente'; btn.innerText = "GUARDAR EXCEDENTE";
            lblMonto.innerText = "Monto Excedente (L.):";
        }
        
        actualizarCuentas();
        pintarReportes();
    };

    // --- GUARDAR ---
    window.guardar = function() {
        const fecha = document.getElementById('fecha').value;
        const monto = parseFloat(document.getElementById('monto').value);

        if(isNaN(monto)) { alert("Falta el monto"); return; }

        let ruta = '', datos = {};

        if(MODO === 'EXCEDENTE') {
            const tar = document.getElementById('exc_tarjeta').value;
            const art = document.getElementById('exc_articulo').value;
            if(!tar || !art) { alert("Falta tarjeta o articulo"); return; }
            ruta = 'excedente_tarjetas';
            datos = { fecha, tarjeta: tar, articulo: art, cuenta: 'LESLY', monto };
        }
        else if(MODO === 'FALTANTES') {
            const cob = document.getElementById('faltante_cobrador').value;
            const zon = document.getElementById('faltante_zona').value;
            if(!cob || !zon) { alert("Falta cobrador o zona"); return; }
            ruta = 'faltantes_cobro';
            datos = { fecha, cobrador: cob, zona: zon, monto };
        }
        else if(MODO === 'ABONOS') {
            const tar = document.getElementById('abono_tarjeta').value;
            const art = document.getElementById('abono_articulo').value;
            const sal = document.getElementById('abono_saldo').value;
            const cue = document.getElementById('abono_cuenta').value;
            if(!tar || !cue) { alert("Falta tarjeta o cuenta"); return; }
            ruta = 'abonos_clientes';
            datos = { fecha, tarjeta: tar, articulo: art, saldo_restante: sal, cuenta: cue, monto };
        } 
        else if(MODO === 'CONTADO') {
            const vend = document.getElementById('vendedor').value;
            const art = document.getElementById('articulo').value;
            const cue = document.getElementById('contado_cuenta').value;
            if(!vend || !cue) { alert("Falta vendedor o cuenta"); return; }
            ruta = 'ventas_contado';
            datos = { fecha, vendedor: vend, articulo: art, cuenta: cue, monto };
        } 
        else { // DEPOSITOS
            const sem = document.getElementById('semana').value;
            const ref = document.getElementById('referencia').value;
            const zon = document.getElementById('zona').value;
            const cob = document.getElementById('cobrador').value;
            const cue = document.getElementById('cuenta').value;
            if(!zon || !ref) { alert("Falta zona o referencia"); return; }
            ruta = 'registros_milagro';
            datos = { origen: MODO, semana: sem, fecha, ref, zona: zon, cobrador: cob, cuenta: cue, monto };
        }

        if(ID_EDITANDO) {
            db.ref(ruta + '/' + ID_EDITANDO).update(datos).then(() => { alert("Actualizado"); cancelar(); });
        } else {
            db.ref(ruta).push(datos).then(() => { 
                limpiarCampos();
                alert("Guardado");
            });
        }
    };

    function limpiarCampos() {
        document.getElementById('monto').value = "";
        document.getElementById('referencia').value = "";
        document.getElementById('articulo').value = "";
        document.getElementById('abono_tarjeta').value = "";
        document.getElementById('abono_articulo').value = "";
        document.getElementById('abono_saldo').value = "";
        document.getElementById('exc_tarjeta').value = "";
        document.getElementById('exc_articulo').value = "";
        
        document.getElementById('faltante_cobrador').value = "";
        document.getElementById('faltante_zona').innerHTML = '<option value="">-- Seleccione Cobrador Primero --</option>';
    }

    // --- REPORTES ---
    function pintarReportes() {
        const cont = document.getElementById('contenedor-reportes');
        cont.innerHTML = "";
        let granTotal = 0;

        // 1. EXCEDENTES (SOLO LESLY)
        if (MODO === 'EXCEDENTE') {
             if (listaExc.length > 0) {
                 listaExc.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                 let sub = 0; let rows = "";
                 listaExc.forEach(r => {
                     sub += r.monto;
                     rows += `<tr>
                         <td>${r.fecha}</td>
                         <td>#${r.tarjeta}</td>
                         <td>${r.articulo}</td>
                         <td style="color:var(--excedente); font-weight:bold;">L. ${r.monto.toLocaleString()}</td>
                         <td class="no-print">
                            <button class="btn-action btn-edit" onclick="editar('${r.id}', 'EXC')">‚úèÔ∏è</button>
                            <button class="btn-action btn-del" onclick="borrar('${r.id}', 'EXC')">üóëÔ∏è</button>
                         </td>
                     </tr>`;
                 });
                 granTotal += sub;
                 cont.innerHTML += `<div class="report-section border-lesly"><h3 class="account-title">EXCEDENTES (CUENTA LESLY) <span>L. ${sub.toLocaleString()}</span></h3><table><thead><tr><th>Fecha</th><th>Tarjeta</th><th>Art√≠culo</th><th>Monto</th><th class="no-print"></th></tr></thead><tbody>${rows}</tbody></table></div>`;
             }
        }
        // 2. FALTANTES
        else if (MODO === 'FALTANTES') {
            const agrupado = {};
            listaFal.forEach(r => { if(!agrupado[r.cobrador]) agrupado[r.cobrador] = []; agrupado[r.cobrador].push(r); });
            for(const cob in agrupado) {
                let sub = 0; let rows = "";
                agrupado[cob].forEach(r => {
                    sub += r.monto;
                    rows += `<tr><td>${r.fecha}</td><td>${r.zona}</td><td style="color:var(--faltante); font-weight:bold;">L. ${r.monto.toLocaleString()}</td><td class="no-print"><button class="btn-action btn-edit" onclick="editar('${r.id}', 'FAL')">‚úèÔ∏è</button><button class="btn-action btn-del" onclick="borrar('${r.id}', 'FAL')">üóëÔ∏è</button></td></tr>`;
                });
                granTotal += sub;
                cont.innerHTML += `<div class="report-section border-faltantes"><h3 class="account-title">FALTANTES ${cob} <span>L. ${sub.toLocaleString()}</span></h3><table><thead><tr><th>Fecha</th><th>Zona</th><th>Monto</th><th class="no-print"></th></tr></thead><tbody>${rows}</tbody></table></div>`;
            }
        }
        // 3. ABONOS
        else if (MODO === 'ABONOS') {
             for (const [key, conf] of Object.entries(configCuentas)) {
                const regs = listaAbo.filter(r => r.cuenta === key);
                if (regs.length > 0) {
                    regs.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                    let sub = 0; let rows = "";
                    regs.forEach(r => {
                        sub += r.monto;
                        rows += `<tr><td>${r.fecha}</td><td><b>#${r.tarjeta}</b></td><td>${r.articulo}</td><td>Rest: L. ${r.saldo_restante}</td><td style="color:var(--abonos); font-weight:bold;">L. ${r.monto.toLocaleString()}</td><td class="no-print"><button class="btn-action btn-edit" onclick="editar('${r.id}', 'ABO')">‚úèÔ∏è</button><button class="btn-action btn-del" onclick="borrar('${r.id}', 'ABO')">üóëÔ∏è</button></td></tr>`;
                    });
                    granTotal += sub;
                    cont.innerHTML += `<div class="report-section ${conf.c}"><h3 class="account-title">ABONOS ${conf.t} <span>L. ${sub.toLocaleString()}</span></h3><table><thead><tr><th>Fecha</th><th>Tarjeta</th><th>Art√≠culo</th><th>Saldo</th><th>Abono</th><th class="no-print"></th></tr></thead><tbody>${rows}</tbody></table></div>`;
                }
            }
        }
        // 4. CONTADO
        else if (MODO === 'CONTADO') {
            for (const [key, conf] of Object.entries(configCuentas)) {
                const regs = listaCon.filter(r => r.cuenta === key);
                if (regs.length > 0) {
                    regs.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                    let sub = 0; let rows = "";
                    regs.forEach(r => {
                        sub += r.monto;
                        rows += `<tr><td>${r.fecha}</td><td><b>${r.vendedor}</b></td><td>${r.articulo}</td><td style="color:var(--contado); font-weight:bold;">L. ${r.monto.toLocaleString()}</td><td class="no-print"><button class="btn-action btn-edit" onclick="editar('${r.id}', 'CON')">‚úèÔ∏è</button><button class="btn-action btn-del" onclick="borrar('${r.id}', 'CON')">üóëÔ∏è</button></td></tr>`;
                    });
                    granTotal += sub;
                    cont.innerHTML += `<div class="report-section ${conf.c}"><h3 class="account-title">VENTAS CONTADO ${conf.t} <span>L. ${sub.toLocaleString()}</span></h3><table><thead><tr><th>Fecha</th><th>Vendedor</th><th>Art√≠culo</th><th>Monto</th><th class="no-print"></th></tr></thead><tbody>${rows}</tbody></table></div>`;
                }
            }
        }
        // 5. DEPOSITOS
        else {
            for (const [key, conf] of Object.entries(configCuentas)) {
                const regs = listaDep.filter(r => r.cuenta === key);
                if (regs.length > 0) {
                    regs.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                    let sub = 0; let rows = ""; let zonaTotal = {};
                    regs.forEach(r => {
                        sub += r.monto;
                        if(!zonaTotal[r.zona]) zonaTotal[r.zona] = 0; zonaTotal[r.zona] += r.monto;
                        let badgeClass = r.origen === 'OFICINA' ? 'bg-oficina' : 'bg-campo';
                        rows += `<tr><td><span class="badge ${badgeClass}">${r.origen.substring(0,3)}</span> ${r.fecha}</td><td>${r.zona}<br><small style="color:#666;">${r.cobrador}</small></td><td>${r.ref}</td><td style="font-weight:bold;">L. ${r.monto.toLocaleString()}</td><td class="no-print"><button class="btn-action btn-edit" onclick="editar('${r.id}', 'DEP')">‚úèÔ∏è</button><button class="btn-action btn-del" onclick="borrar('${r.id}', 'DEP')">üóëÔ∏è</button></td></tr>`;
                    });
                    granTotal += sub;
                    let resumenHtml = `<div class="zone-summary"><b>Resumen por Zona:</b>`;
                    for(const z in zonaTotal) resumenHtml += `<div class="zone-row"><span>${z}</span><span>L. ${zonaTotal[z].toLocaleString()}</span></div>`;
                    resumenHtml += `</div>`;
                    cont.innerHTML += `<div class="report-section ${conf.c}"><h3 class="account-title">${conf.t} <span>L. ${sub.toLocaleString()}</span></h3><table><thead><tr><th>Fecha</th><th>Zona</th><th>Ref</th><th>Monto</th><th class="no-print"></th></tr></thead><tbody>${rows}</tbody></table>${resumenHtml}</div>`;
                }
            }
        }
        document.getElementById('total-global').innerText = "L. " + granTotal.toLocaleString();
    }

    // --- UTILS ---
    window.borrar = function(id, tipo) {
        if(confirm("¬øEliminar registro?")) {
            let ruta = '';
            if(tipo === 'EXC') ruta = 'excedente_tarjetas';
            else if(tipo === 'FAL') ruta = 'faltantes_cobro';
            else if(tipo === 'ABO') ruta = 'abonos_clientes';
            else if(tipo === 'CON') ruta = 'ventas_contado';
            else ruta = 'registros_milagro';
            db.ref(ruta + '/' + id).remove();
        }
    }

    window.editar = function(id, tipo) {
        ID_EDITANDO = id;
        document.getElementById('btn-cancelar').style.display = 'block';
        document.getElementById('btn-guardar').innerText = "ACTUALIZAR";
        window.scrollTo(0,0);

        if(tipo === 'EXC') {
            const r = listaExc.find(x => x.id === id);
            cambiarModo('EXCEDENTE');
            document.getElementById('fecha').value = r.fecha;
            document.getElementById('exc_tarjeta').value = r.tarjeta;
            document.getElementById('exc_articulo').value = r.articulo;
            document.getElementById('monto').value = r.monto;
        }
        else if(tipo === 'FAL') {
            const r = listaFal.find(x => x.id === id);
            cambiarModo('FALTANTES');
            document.getElementById('fecha').value = r.fecha;
            document.getElementById('faltante_cobrador').value = r.cobrador;
            actualizarZonasFaltante();
            document.getElementById('faltante_zona').value = r.zona;
            document.getElementById('monto').value = r.monto;
        }
        else if(tipo === 'ABO') {
            const r = listaAbo.find(x => x.id === id);
            cambiarModo('ABONOS');
            document.getElementById('fecha').value = r.fecha;
            document.getElementById('abono_tarjeta').value = r.tarjeta;
            document.getElementById('abono_articulo').value = r.articulo;
            document.getElementById('abono_saldo').value = r.saldo_restante;
            document.getElementById('abono_cuenta').value = r.cuenta;
            document.getElementById('monto').value = r.monto;
        } 
        else if(tipo === 'CON') {
            const r = listaCon.find(x => x.id === id);
            cambiarModo('CONTADO');
            document.getElementById('fecha').value = r.fecha;
            document.getElementById('vendedor').value = r.vendedor;
            document.getElementById('articulo').value = r.articulo;
            document.getElementById('contado_cuenta').value = r.cuenta;
            document.getElementById('monto').value = r.monto;
        } 
        else {
            const r = listaDep.find(x => x.id === id);
            cambiarModo(r.origen);
            document.getElementById('fecha').value = r.fecha;
            document.getElementById('semana').value = r.semana;
            document.getElementById('referencia').value = r.ref;
            document.getElementById('zona').value = r.zona;
            autoCobrador();
            document.getElementById('cuenta').value = r.cuenta;
            document.getElementById('monto').value = r.monto;
        }
    }

    window.cancelar = function() {
        ID_EDITANDO = null;
        document.getElementById('btn-cancelar').style.display = 'none';
        limpiarCampos();
        let txt = "";
        if(MODO === 'OFICINA') txt = "(OFICINA)"; else if(MODO === 'CAMPO') txt = "(CAMPO)"; else if(MODO === 'FALTANTES') txt = "FALTANTE"; else if(MODO === 'EXCEDENTE') txt = "EXCEDENTE"; else if(MODO === 'CONTADO') txt = "VENTA CONTADO"; else txt = "ABONO";
        document.getElementById('btn-guardar').innerText = "GUARDAR " + txt;
    }

    function llenarZonas() {
        const sel = document.getElementById('zona');
        for (const [cob, list] of Object.entries(rutas)) {
            const grp = document.createElement('optgroup'); grp.label = cob;
            list.forEach(z => {
                const op = document.createElement('option'); op.value = z; op.innerText = z; op.setAttribute('data-c', cob);
                grp.appendChild(op);
            });
            sel.appendChild(grp);
        }
    }
    
    window.autoCobrador = function() {
        const sel = document.getElementById('zona');
        document.getElementById('cobrador').value = sel.options[sel.selectedIndex].getAttribute('data-c') || "";
    }

    window.actualizarZonasFaltante = function() {
        const cob = document.getElementById('faltante_cobrador').value;
        const sel = document.getElementById('faltante_zona');
        sel.innerHTML = '<option value="">-- Seleccione Zona --</option>';
        if(rutas[cob]) {
            rutas[cob].forEach(z => {
                const op = document.createElement('option'); op.value = z; op.innerText = z;
                sel.appendChild(op);
            });
        }
    }

    function actualizarCuentas() {
        const c = document.getElementById('cuenta');
        c.innerHTML = MODO === 'OFICINA' 
            ? "<option value='LESLY'>CUENTA LESLY</option>" 
            : "<option value='DAVID'>CUENTA DAVID</option><option value='DAVID_LESLY'>DAVID (VIA LESLY)</option><option value='JOSE_RODINDER'>JOSE RODINDER</option>";
    }

    function llenarCuentasExtra() {
        const opciones = `
            <option value="DAVID">CUENTA DAVID</option>
            <option value="LESLY">CUENTA LESLY</option>
            <option value="DAVID_LESLY">DAVID (VIA LESLY)</option>
            <option value="JOSE_RODINDER">JOSE RODINDER</option>
        `;
        document.getElementById('abono_cuenta').innerHTML = opciones;
        document.getElementById('contado_cuenta').innerHTML = opciones;
    }
</script>

</body>
</html>
