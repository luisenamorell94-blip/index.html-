<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA INTERNO V34 - ADMIN</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --lime: #B9FF66;       
            --black: #191A23;      
            --gray: #F3F3F3;       
            --white: #FFFFFF;
            --dark-gray: #292A32;
            --danger: #FF6666;
        }
        
        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background: var(--white); 
            color: var(--black);
            margin: 0; 
            padding: 20px; 
            padding-bottom: 80px; 
        }
        
        .container { max-width: 1000px; margin: 0 auto; }

        /* HEADER */
        header { display: flex; align-items: center; justify-content: center; margin-bottom: 30px; background: var(--black); padding: 20px; border-radius: 15px; }
        h2.logo { font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px; color: var(--lime); text-transform: uppercase; letter-spacing: 1px; }
        
        /* PESTA√ëAS */
        .tabs-container { overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .tabs { display: flex; gap: 10px; min-width: max-content; }
        .tab { 
            padding: 10px 20px; 
            border: 1px solid var(--black);
            border-radius: 10px; 
            font-weight: 500; 
            cursor: pointer; 
            font-size: 0.9rem; 
            transition: 0.2s;
            background: var(--white);
            box-shadow: 0 3px 0 var(--black);
            margin-bottom: 3px; 
        }
        .tab:active { box-shadow: 0 0 0 var(--black); transform: translateY(3px); }
        
        .active-tab { background: var(--lime) !important; font-weight: bold; }
        .active-historial { background: var(--black) !important; color: var(--white) !important; }
        .active-config { background: #e0e0e0 !important; border: 2px dashed var(--black) !important; }

        /* FORMULARIO */
        .card { 
            background: var(--gray); 
            padding: 30px; 
            border-radius: 30px; 
            border: 1px solid var(--black);
            box-shadow: 0 5px 0 var(--black);
            margin-bottom: 40px;
        }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full { grid-column: span 2; }
        
        label { display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 8px; }
        input, select { 
            width: 100%; 
            padding: 15px; 
            border: 1px solid var(--black); 
            border-radius: 10px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            font-family: 'Space Grotesk', sans-serif;
            background: var(--white);
        }
        input:focus, select:focus { outline: none; background: #fff; box-shadow: 4px 4px 0 var(--lime); }
        
        /* BOTONES */
        button { 
            width: 100%; 
            padding: 18px; 
            border: 1px solid var(--black); 
            border-radius: 12px; 
            font-weight: 700; 
            font-size: 1.1rem; 
            cursor: pointer; 
            margin-top: 25px; 
            font-family: 'Space Grotesk', sans-serif;
            transition: 0.2s;
        }
        
        #btn-guardar { background: var(--black); color: var(--white); }
        #btn-guardar:hover { background: var(--dark-gray); box-shadow: 0 4px 0 var(--lime); }
        #btn-cancelar { background: var(--white); color: var(--black); margin-top: 10px; display: none; }
        .btn-historial { background: var(--lime); color: var(--black); }
        .btn-config { background: #e0e0e0; color: var(--black); border: 2px dashed var(--black); }
        .btn-pdf { background: #ff4d4d; color: white; box-shadow: 0 4px 0 #990000; }

        /* CONFIGURACION STYLES */
        .config-section { margin-bottom: 30px; border-bottom: 2px dashed #ccc; padding-bottom: 20px; }
        .config-list { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
        .tag-item { background: var(--white); border: 1px solid var(--black); padding: 5px 10px; border-radius: 20px; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .tag-del { color: var(--danger); cursor: pointer; font-weight: bold; padding: 0 5px; }
        .row-flex { display: flex; gap: 10px; align-items: flex-end; }
        .row-flex button { margin-top: 0; width: auto; padding: 15px 25px; background: var(--lime); }

        /* REPORTES */
        #area-impresion { margin-top: 40px; }
        .report-title-main { background: var(--lime); display: inline-block; padding: 5px 15px; border-radius: 5px; font-weight: bold; margin-bottom: 20px; }

        .report-section { 
            background: var(--white); 
            border: 1px solid var(--black); 
            border-radius: 20px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 0 var(--black);
        }
        
        /* BORDES DINAMICOS */
        .border-blue { border-left: 10px solid #1565c0; }
        .border-pink { border-left: 10px solid #ad1457; }
        .border-purple { border-left: 10px solid #6a1b9a; }
        .border-green { border-left: 10px solid #2e7d32; }
        .border-red { border-left: 10px solid #c62828; }
        
        .account-title { display: flex; justify-content: space-between; align-items: center; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px dashed #ccc; font-size: 1.2rem; font-weight: 700; }
        .account-title span { background: var(--black); color: var(--white); padding: 5px 10px; border-radius: 8px; font-size: 1rem; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th { text-align: left; padding: 10px; color: #666; font-size: 0.8rem; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; font-weight: 500; }
        
        .btn-action { padding: 5px 10px; border: 1px solid var(--black); border-radius: 6px; cursor: pointer; margin-left: 5px; font-weight: bold; font-size: 0.8rem; }
        .btn-edit { background: var(--lime); }
        .btn-del { background: #ffcccc; }

        .zone-summary { background: #191A23; color: white; padding: 15px; margin-top: 15px; border-radius: 10px; font-size: 0.9rem; }
        .zone-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333; }
        
        .total-box { background: var(--black); color: var(--lime); padding: 20px; text-align: right; font-weight: bold; font-size: 1.5rem; border-radius: 15px; margin-top: 30px; border: 2px solid var(--lime); }
        .hidden { display: none; }

        @media print { .no-print { display: none; } .card { border: none; shadow: none; } }
    </style>
</head>
<body>

<div class="container">
    <header class="no-print">
        <h2 class="logo">SISTEMA INTERNO BY LUIS ENAMORADO</h2>
    </header>

    <div class="tabs-container no-print">
        <div class="tabs">
            <div id="tab-oficina" class="tab active-tab" onclick="cambiarPestana('OFICINA')">OFICINA</div>
            <div id="tab-campo" class="tab" onclick="cambiarPestana('CAMPO')">CAMPO</div>
            <div id="tab-contado" class="tab" onclick="cambiarPestana('CONTADO')">CONTADO</div>
            <div id="tab-abonos" class="tab" onclick="cambiarPestana('ABONOS')">ABONOS</div>
            <div id="tab-faltantes" class="tab" onclick="cambiarPestana('FALTANTES')">FALTANTES</div>
            <div id="tab-excedente" class="tab" onclick="cambiarPestana('EXCEDENTE')">EXCEDENTE</div>
            <div id="tab-historial" class="tab" onclick="cambiarPestana('HISTORIAL')">HISTORIAL</div>
            <div id="tab-config" class="tab" onclick="cambiarPestana('CONFIG')">‚öôÔ∏è CONFIG</div>
        </div>
    </div>

    <div id="block-config" class="card hidden no-print">
        <h2 style="margin-top:0;">‚öôÔ∏è CONFIGURACI√ìN DEL SISTEMA</h2>
        <p>Aqu√≠ puedes agregar o quitar cobradores, zonas y cuentas.</p>

        <div class="config-section">
            <h3>üèçÔ∏è GESTI√ìN DE RUTAS (Cobradores y Zonas)</h3>
            <div class="row-flex">
                <div style="flex:1;">
                    <label>Nuevo Cobrador:</label>
                    <input type="text" id="new_cobrador" placeholder="Nombre (Ej. CARLOS)">
                </div>
                <button onclick="addCobrador()">AGREGAR COBRADOR</button>
            </div>
            
            <div style="margin-top:20px;">
                <label>Selecciona Cobrador para Editar sus Zonas:</label>
                <select id="config_cobrador_sel" onchange="renderConfigZonas()"></select>
            </div>

            <div id="zona_manager_block" class="hidden" style="margin-top:15px; background:#fff; padding:15px; border-radius:15px; border:1px solid #ccc;">
                <label>Zonas de <span id="lbl_cobrador_edit"></span>:</label>
                <div id="list_zonas" class="config-list"></div>
                <div class="row-flex" style="margin-top:10px;">
                    <input type="text" id="new_zona" placeholder="Nueva Zona">
                    <button onclick="addZona()">+ ZONA</button>
                </div>
                <button onclick="deleteCobrador()" style="background:var(--danger); color:white; margin-top:20px;">ELIMINAR ESTE COBRADOR</button>
            </div>
        </div>

        <div class="config-section">
            <h3>üí∞ GESTI√ìN DE CUENTAS</h3>
            <div class="row-flex">
                <div style="flex:2;">
                    <label>Nombre Cuenta:</label>
                    <input type="text" id="new_cuenta_name" placeholder="Ej. CUENTA NUEVA">
                </div>
                <div style="flex:1;">
                    <label>Color:</label>
                    <select id="new_cuenta_color">
                        <option value="border-blue">Azul</option>
                        <option value="border-pink">Rosa</option>
                        <option value="border-purple">Morado</option>
                        <option value="border-green">Verde</option>
                        <option value="border-red">Rojo</option>
                    </select>
                </div>
                <button onclick="addCuenta()">AGREGAR</button>
            </div>
            <label style="margin-top:15px;">Cuentas Activas:</label>
            <div id="list_cuentas" class="config-list"></div>
        </div>

        <button onclick="guardarConfiguracionEnNube()" id="btn-guardar-config" style="background:var(--black); color:var(--lime);">üíæ GUARDAR TODOS LOS CAMBIOS</button>
    </div>

    <div id="operational-card" class="card no-print">
        <div class="full" style="margin-bottom: 20px;">
            <label>üìÖ Fecha del Recibo</label>
            <input type="date" id="fecha">
            <small style="color:#666; margin-top:5px; display:block;">* El registro se guardar√° en la carga de HOY.</small>
        </div>

        <div id="block-depositos" class="form-grid">
            <div><label>Semana</label><select id="semana"><option>Semana 1</option><option>Semana 2</option><option>Semana 3</option><option>Semana 4</option><option>Semana 5</option></select></div>
            <div><label>Referencia</label><input type="number" id="ref" placeholder="Ej. 12345"></div>
            
            <div class="full"><label>Cobrador (Vendedor)</label>
                <select id="cobrador_dep" onchange="cargarZonasDeposito()">
                    <option value="">-- Seleccione Primero --</option>
                </select>
            </div>
            <div class="full"><label>Zona</label><select id="zona_dep"></select></div>
            
            <div class="full"><label>Cuenta Destino</label>
                <select id="cuenta"></select>
            </div>
        </div>

        <div id="block-contado" class="form-grid hidden">
            <div><label>Vendedor</label>
                <select id="vendedor">
                    <option>SANTOS</option><option>NOE</option><option>CARLOS</option>
                    <option>RAMON</option><option>ORLANDO</option><option>DAVID</option>
                </select>
            </div>
            <div><label>Cuenta Destino</label>
                <select id="contado_cuenta"></select>
            </div>
            <div class="full"><label>Art√≠culo</label><input type="text" id="articulo_contado" placeholder="Ej. Cama Matrimonial"></div>
        </div>

        <div id="block-abonos" class="form-grid hidden">
            <div><label># Tarjeta</label><input type="text" id="abono_tarjeta" placeholder="0000"></div>
            <div><label>Art√≠culo</label><input type="text" id="abono_articulo"></div>
            <div><label>Saldo Restante</label><input type="number" id="abono_saldo" placeholder="0.00"></div>
            <div><label>Cuenta Destino</label>
                <select id="abono_cuenta"></select>
            </div>
        </div>

        <div id="block-faltantes" class="form-grid hidden">
            <div class="full"><label>Cobrador</label>
                <select id="fal_cobrador" onchange="zonaFaltante()"></select>
            </div>
            <div class="full"><label>Zona del Faltante</label><select id="fal_zona"></select></div>
        </div>

        <div id="block-excedente" class="form-grid hidden">
            <div><label># Tarjeta</label><input type="text" id="exc_tarjeta"></div>
            <div><label>Art√≠culo</label><input type="text" id="exc_articulo"></div>
            <div class="full"><label>Cuenta Destino</label>
                <select id="exc_cuenta"></select>
            </div>
        </div>

        <div id="block-historial" class="hidden" style="text-align:center; padding: 20px;">
            <h3 style="margin-bottom:10px;">CONSULTAR REGISTROS ANTIGUOS</h3>
            <p style="margin-bottom:20px;">Selecciona la fecha de carga:</p>
            <input type="date" id="fecha_historial" style="max-width:300px; margin:0 auto;">
            <button class="btn-historial" onclick="buscarHistorial()" style="max-width:300px; margin-top:20px;">üîç BUSCAR REPORTE</button>
        </div>

        <div id="block-monto" class="full" style="margin-top: 20px;">
            <label style="font-size:1.1rem;">üíµ Monto a Ingresar (L.)</label>
            <input type="number" id="monto" style="font-size:1.5rem; font-weight:bold; border: 2px solid var(--black);" step="0.01" placeholder="0.00">
        </div>

        <button id="btn-cancelar" onclick="cancelarEdicion()">CANCELAR EDICI√ìN</button>
        <button id="btn-guardar" onclick="guardar()">GUARDAR REGISTRO</button>
    </div>

    <div id="area-impresion">
        <div class="report-title-main no-print" id="titulo-reporte">REPORTE DE HOY</div>
        <div id="reportes"></div>
        <div class="total-box">TOTAL GLOBAL: <span id="gran-total">L. 0.00</span></div>
    </div>

    <button class="btn-pdf no-print" onclick="window.print()">üìÑ GUARDAR PDF / IMPRIMIR</button>
</div>

<script>
    // --- CONEXION ---
    const firebaseConfig = { apiKey: "AIzaSyAYJRmMQbV-j6hGfHCZyuCgtvmkY0C2L1g", authDomain: "ingreso-depositos.firebaseapp.com", databaseURL: "https://ingreso-depositos-default-rtdb.firebaseio.com", projectId: "ingreso-depositos", storageBucket: "ingreso-depositos.firebasestorage.app", messagingSenderId: "788432921819", appId: "1:788432921819:web:b5f792eecbe4b7b00498fe" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- VARIABLES ---
    let MODO = 'OFICINA'; 
    let ID_EDIT = null;
    let RUTA_EDIT = null; 
    let HOY = new Date().toISOString().split('T')[0];
    let FILTRO = HOY;
    
    let datos = { dep:[], con:[], abo:[], fal:[], exc:[] };
    
    // --- CONFIGURACION DINAMICA (Inicial por defecto si est√° vac√≠a) ---
    let RUTAS_DB = { 
        "MIGUEL": ["Elixir","Saba Olanchito", "Zona Saba"], 
        "ANGEL": ["Margen Izquierda","Saba Tocoa"], 
        "FERNANDO": ["Vicinia","Trujillo", "Honduras Aguan"], 
        "AMALET": ["Balfate","Bonito Oriental"], 
        "JORGE": ["Planes Jutiapa", "Sonaguera", "Faust"] 
    };
    
    let CUENTAS_DB = { 
        "DAVID": { nombre: "CUENTA DAVID", color: "border-blue" },
        "LESLY": { nombre: "CUENTA LESLY", color: "border-pink" },
        "DAVID_LESLY": { nombre: "DAVID (VIA LESLY)", color: "border-purple" },
        "JOSE_RODINDER": { nombre: "JOSE RODINDER", color: "border-green" }
    };

    // --- INICIO ---
    window.onload = function() {
        document.getElementById('fecha').value = HOY;
        document.getElementById('fecha_historial').value = HOY;
        
        // 1. CARGAR CONFIGURACION
        db.ref('configuracion_sistema').once('value', snapshot => {
            if(snapshot.exists()) {
                const config = snapshot.val();
                if(config.rutas) RUTAS_DB = config.rutas;
                if(config.cuentas) CUENTAS_DB = config.cuentas;
            } else {
                // Si no existe, guardar la default
                guardarConfiguracionEnNube(true);
            }
            inicializarListas();
            // 2. CARGAR DATOS OPERATIVOS
            cargarDatosReales();
        });
        
        cambiarPestana('OFICINA');
    };

    function cargarDatosReales() {
        db.ref('registros_milagro').on('value', s => { datos.dep=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.dep.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('ventas_contado').on('value', s => { datos.con=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.con.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('abonos_clientes').on('value', s => { datos.abo=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.abo.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('faltantes_cobro').on('value', s => { datos.fal=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.fal.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('excedente_tarjetas').on('value', s => { datos.exc=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.exc.push({id:k,...s.val()[k]})); pintar(); });
    }

    // --- GESTION DE CONFIGURACION ---
    function inicializarListas() {
        // Llenar selects operativos
        llenarSelectCobradores('cobrador_dep');
        llenarSelectCobradores('fal_cobrador');
        
        // Cuentas (Todas)
        actualizarSelectCuentas('contado_cuenta');
        actualizarSelectCuentas('abono_cuenta');
        actualizarSelectCuentas('exc_cuenta');
        // El de deposito depende de la pesta√±a, se llena en cambiarPestana
    }

    function llenarSelectCobradores(idSelect) {
        const sel = document.getElementById(idSelect);
        sel.innerHTML = '<option value="">-- Seleccione --</option>';
        Object.keys(RUTAS_DB).forEach(cob => {
            let op = document.createElement('option');
            op.value = cob; op.innerText = cob;
            sel.appendChild(op);
        });
    }

    function actualizarSelectCuentas(idSelect) {
        const sel = document.getElementById(idSelect);
        sel.innerHTML = "";
        Object.keys(CUENTAS_DB).forEach(key => {
            let op = document.createElement('option');
            op.value = key; op.innerText = CUENTAS_DB[key].nombre;
            sel.appendChild(op);
        });
    }

    // --- LOGICA DE PESTA√ëAS ---
    function cambiarPestana(m) {
        if(ID_EDIT) { if(!confirm("Est√°s editando. ¬øCancelar?")) return; cancelarEdicion(); }
        MODO = m;
        actualizarUI();
    }

    function actualizarUI() {
        document.querySelectorAll('.tab').forEach(t => t.className = 'tab');
        if(document.getElementById('tab-'+MODO.toLowerCase())) {
            document.getElementById('tab-'+MODO.toLowerCase()).classList.add('active-tab');
            if(MODO === 'HISTORIAL') document.getElementById('tab-historial').classList.add('active-historial');
            if(MODO === 'CONFIG') document.getElementById('tab-config').classList.add('active-config');
        }
        
        document.querySelectorAll('.form-grid').forEach(b => b.classList.add('hidden'));
        document.getElementById('block-historial').classList.add('hidden');
        document.getElementById('block-config').classList.add('hidden');
        document.getElementById('operational-card').classList.remove('hidden');
        document.getElementById('block-monto').classList.remove('hidden');
        document.getElementById('btn-guardar').style.display='block';

        if(MODO=='OFICINA' || MODO=='CAMPO') {
            document.getElementById('block-depositos').classList.remove('hidden');
            let selectCuenta = document.getElementById('cuenta');
            selectCuenta.innerHTML = "";
            
            // FILTRO DE CUENTAS POR MODO
            if(MODO === 'OFICINA') {
                // Solo Lesly o cuentas de oficina si agregas mas
                if(CUENTAS_DB['LESLY']) {
                    selectCuenta.innerHTML = `<option value='LESLY'>${CUENTAS_DB['LESLY'].nombre}</option>`;
                }
            } else {
                // Todas MENOS Lesly
                Object.keys(CUENTAS_DB).forEach(key => {
                    if(key !== 'LESLY') {
                        let op = document.createElement('option');
                        op.value = key; op.innerText = CUENTAS_DB[key].nombre;
                        selectCuenta.appendChild(op);
                    }
                });
            }
        }
        else if(MODO=='CONTADO') document.getElementById('block-contado').classList.remove('hidden');
        else if(MODO=='ABONOS') document.getElementById('block-abonos').classList.remove('hidden');
        else if(MODO=='FALTANTES') document.getElementById('block-faltantes').classList.remove('hidden');
        else if(MODO=='EXCEDENTE') document.getElementById('block-excedente').classList.remove('hidden');
        else if(
