<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comercial GYG - Sistema Maestro</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { 
            --primary: #004d40; /* Oficina Verde */
            --field: #e65100;   /* Campo Naranja */
            --contado: #4a148c; 
            --abonos: #1565c0; 
            --faltante: #c62828; 
            --excedente: #00838f; 
            --historial: #455a64;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; padding-bottom: 80px; }
        
        /* HEADER */
        header { background: #263238; color: white; padding: 10px; text-align: center; border-radius: 0 0 8px 8px; margin-bottom: 15px; }
        
        /* PESTA√ëAS */
        .tabs { display: flex; gap: 5px; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .tab { flex: 1; min-width: 90px; padding: 12px; text-align: center; font-weight: bold; background: #ccc; color: #555; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
        
        /* COLORES ACTIVOS */
        .active-oficina { background: white; color: var(--primary); border-bottom: 4px solid var(--primary); }
        .active-campo { background: white; color: var(--field); border-bottom: 4px solid var(--field); }
        .active-contado { background: white; color: var(--contado); border-bottom: 4px solid var(--contado); }
        .active-abonos { background: white; color: var(--abonos); border-bottom: 4px solid var(--abonos); }
        .active-faltantes { background: white; color: var(--faltante); border-bottom: 4px solid var(--faltante); }
        .active-excedente { background: white; color: var(--excedente); border-bottom: 4px solid var(--excedente); }
        .active-historial { background: white; color: var(--historial); border-bottom: 4px solid var(--historial); }

        /* FORMULARIO */
        .card { background: white; padding: 15px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full { grid-column: span 2; }
        
        label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; margin-top: 8px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* BOTONES */
        button { width: 100%; padding: 15px; border: none; border-radius: 5px; font-weight: bold; color: white; cursor: pointer; margin-top: 15px; font-size: 1rem; }
        .btn-oficina { background: var(--primary); }
        .btn-campo { background: var(--field); }
        .btn-contado { background: var(--contado); }
        .btn-abonos { background: var(--abonos); }
        .btn-faltantes { background: var(--faltante); }
        .btn-excedente { background: var(--excedente); }
        .btn-historial { background: var(--historial); }
        
        #btn-cancelar { background: #616161; display: none; margin-bottom: 10px; }
        .btn-pdf { background: #d32f2f; margin-top: 20px; }

        /* REPORTES */
        #area-impresion { margin-top: 20px; }
        .report-section { background: white; border-radius: 8px; padding: 10px; margin-bottom: 15px; border-top: 5px solid #555; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .border-david { border-top-color: #1565c0; }
        .border-lesly { border-top-color: #ad1457; }
        .border-mix { border-top-color: #6a1b9a; }
        .border-jose { border-top-color: #2e7d32; }
        .border-abonos { border-top-color: #1565c0; }
        .border-faltantes { border-top-color: #c62828; }
        
        .account-title { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; font-size: 1rem; color: #333; }
        .account-title span { font-weight: bold; font-size: 1.1rem; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 5px; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f5f5f5; }
        
        .btn-action { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin-left: 2px; font-size: 0.9rem; }
        .btn-edit { background: #e3f2fd; color: #1565c0; }
        .btn-del { background: #ffebee; color: #c62828; }

        /* BADGES PARA DIFERENCIAR OFICINA Y CAMPO */
        .badge { padding: 3px 6px; border-radius: 4px; color: white; font-size: 0.7rem; font-weight: bold; margin-right: 5px; }
        .bg-oficina { background: var(--primary); }
        .bg-campo { background: var(--field); }

        .zone-summary { background: #f9f9f9; padding: 10px; margin-top: 10px; font-size: 0.85rem; border-radius: 4px; border: 1px dashed #ccc; }
        .zone-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px dotted #ddd; }
        .zone-row:last-child { border-bottom: none; }

        .total-box { background: #333; color: white; padding: 10px; text-align: right; font-weight: bold; font-size: 1.2rem; }
        .hidden { display: none; }

        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<header class="no-print"><h2>SISTEMA GYG</h2></header>

<div class="container" style="max-width:900px; margin:0 auto;">

    <div class="tabs no-print">
        <div id="tab-oficina" class="tab active-oficina" onclick="cambiarPestana('OFICINA')">OFICINA</div>
        <div id="tab-campo" class="tab" onclick="cambiarPestana('CAMPO')">CAMPO</div>
        <div id="tab-contado" class="tab" onclick="cambiarPestana('CONTADO')">CONTADO</div>
        <div id="tab-abonos" class="tab" onclick="cambiarPestana('ABONOS')">ABONOS</div>
        <div id="tab-faltantes" class="tab" onclick="cambiarPestana('FALTANTES')">FALTANTES</div>
        <div id="tab-excedente" class="tab" onclick="cambiarPestana('EXCEDENTE')">EXCEDENTE</div>
        <div id="tab-historial" class="tab" onclick="cambiarPestana('HISTORIAL')">HISTORIAL</div>
    </div>

    <div class="card no-print">
        <div class="full">
            <label>Fecha del Recibo:</label>
            <input type="date" id="fecha">
            <small style="color:#004d40">‚ÑπÔ∏è Se guardar√° en el reporte de HOY (Carga diaria).</small>
        </div>

        <div id="block-depositos" class="form-grid">
            <div><label>Semana:</label><select id="semana"><option>Semana 1</option><option>Semana 2</option><option>Semana 3</option><option>Semana 4</option><option>Semana 5</option></select></div>
            <div><label>Referencia:</label><input type="number" id="ref"></div>
            <div class="full"><label>Zona:</label><select id="zona" onchange="autoCobrador()"></select></div>
            <div class="full"><label>Cobrador:</label><input type="text" id="cobrador" readonly style="background:#eee;"></div>
            <div class="full"><label>Cuenta Destino:</label>
                <select id="cuenta">
                    <option value="DAVID">CUENTA DAVID</option>
                    <option value="DAVID_LESLY">DAVID (VIA LESLY)</option>
                    <option value="JOSE_RODINDER">JOSE RODINDER</option>
                </select>
            </div>
        </div>

        <div id="block-contado" class="form-grid hidden">
            <div><label>Vendedor:</label>
                <select id="vendedor">
                    <option>SANTOS</option><option>NOE</option><option>CARLOS</option>
                    <option>RAMON</option><option>ORLANDO</option><option>DAVID</option>
                </select>
            </div>
            <div><label>Cuenta Destino:</label>
                <select id="contado_cuenta">
                    <option value="DAVID">CUENTA DAVID</option>
                    <option value="DAVID_LESLY">DAVID (VIA LESLY)</option>
                    <option value="JOSE_RODINDER">JOSE RODINDER</option>
                </select>
            </div>
            <div class="full"><label>Art√≠culo:</label><input type="text" id="articulo_contado"></div>
        </div>

        <div id="block-abonos" class="form-grid hidden">
            <div><label>Tarjeta:</label><input type="text" id="abono_tarjeta"></div>
            <div><label>Art√≠culo:</label><input type="text" id="abono_articulo"></div>
            <div><label>Saldo:</label><input type="number" id="abono_saldo"></div>
            <div><label>Cuenta Destino:</label>
                <select id="abono_cuenta">
                    <option value="DAVID">CUENTA DAVID</option>
                    <option value="DAVID_LESLY">DAVID (VIA LESLY)</option>
                    <option value="JOSE_RODINDER">JOSE RODINDER</option>
                </select>
            </div>
        </div>

        <div id="block-faltantes" class="form-grid hidden">
            <div class="full"><label>Cobrador:</label>
                <select id="fal_cobrador" onchange="zonaFaltante()">
                    <option value="">-- Seleccione --</option>
                    <option value="MIGUEL">MIGUEL</option><option value="ANGEL">ANGEL</option>
                    <option value="FERNANDO">FERNANDO</option><option value="AMALET">AMALET</option><option value="JORGE">JORGE</option>
                </select>
            </div>
            <div class="full"><label>Zona:</label><select id="fal_zona"></select></div>
        </div>

        <div id="block-excedente" class="form-grid hidden">
            <div><label>Tarjeta:</label><input type="text" id="exc_tarjeta"></div>
            <div><label>Art√≠culo:</label><input type="text" id="exc_articulo"></div>
            <div class="full"><label>Cuenta Destino:</label>
                <select id="exc_cuenta">
                    <option value="DAVID">CUENTA DAVID</option>
                    <option value="DAVID_LESLY">DAVID (VIA LESLY)</option>
                    <option value="JOSE_RODINDER">JOSE RODINDER</option>
                </select>
            </div>
        </div>

        <div id="block-historial" class="hidden" style="text-align:center;">
            <h3>BUSCAR REPORTE ANTIGUO</h3>
            <p>Selecciona el d√≠a que hiciste la carga:</p>
            <input type="date" id="fecha_historial" style="max-width:200px; margin:10px auto;">
            <button class="main-btn btn-historial" onclick="buscarHistorial()">BUSCAR</button>
        </div>

        <div id="block-monto" class="full">
            <label>Monto (L.):</label>
            <input type="number" id="monto" style="font-size:1.2rem; font-weight:bold;" step="0.01">
        </div>

        <button id="btn-cancelar" onclick="cancelarEdicion()">CANCELAR EDICI√ìN</button>
        <button id="btn-guardar" class="btn-oficina" onclick="guardar()">GUARDAR</button>
    </div>

    <div id="area-impresion">
        <h3 id="titulo-reporte" class="no-print">REPORTE DE HOY</h3>
        <div id="reportes"></div>
        <div class="total-box">TOTAL: <span id="gran-total">L. 0.00</span></div>
    </div>

    <button class="btn-pdf no-print" onclick="window.print()">IMPRIMIR PDF</button>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAYJRmMQbV-j6hGfHCZyuCgtvmkY0C2L1g", authDomain: "ingreso-depositos.firebaseapp.com", databaseURL: "https://ingreso-depositos-default-rtdb.firebaseio.com", projectId: "ingreso-depositos", storageBucket: "ingreso-depositos.firebasestorage.app", messagingSenderId: "788432921819", appId: "1:788432921819:web:b5f792eecbe4b7b00498fe" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // VARIABLES
    let MODO = 'OFICINA'; 
    let ID_EDIT = null;
    let RUTA_EDIT = null; 
    let HOY = new Date().toISOString().split('T')[0];
    let FILTRO = HOY;
    let ES_HISTORIAL = false;

    let datos = { dep:[], con:[], abo:[], fal:[], exc:[] };
    
    // ZONAS ACTUALIZADAS (CON FAUST, JUTIAPA, HONDURAS AGUAN, ETC)
    const rutas = { 
        "MIGUEL": ["Elixir","Saba Olanchito", "Zona Saba"], 
        "ANGEL": ["Margen Izquierda","Saba Tocoa"], 
        "FERNANDO": ["Vicinia","Trujillo", "Honduras Aguan"], 
        "AMALET": ["Balfate","Bonito Oriental"], 
        "JORGE": ["Planes","Jutiapa", "Sonaguera", "Faust"] 
    };
    
    const cuentas = { "DAVID":"border-david", "DAVID_LESLY":"border-mix", "JOSE_RODINDER":"border-jose" };

    window.onload = function() {
        document.getElementById('fecha').value = HOY;
        document.getElementById('fecha_historial').value = HOY;
        llenarZonas();
        
        // CARGA DE DATOS
        db.ref('registros_milagro').on('value', s => { datos.dep=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.dep.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('ventas_contado').on('value', s => { datos.con=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.con.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('abonos_clientes').on('value', s => { datos.abo=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.abo.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('faltantes_cobro').on('value', s => { datos.fal=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.fal.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('excedente_tarjetas').on('value', s => { datos.exc=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.exc.push({id:k,...s.val()[k]})); pintar(); });
    };

    function cambiarPestana(m) {
        if(ID_EDIT) { if(!confirm("Est√°s editando. ¬øCancelar?")) return; cancelarEdicion(); }
        MODO = m;
        actualizarUI();
    }

    function actualizarUI() {
        document.querySelectorAll('.tab').forEach(t => t.className='tab');
        if(document.getElementById('tab-'+MODO.toLowerCase())) {
            document.getElementById('tab-'+MODO.toLowerCase()).className = `tab active-${MODO.toLowerCase()}`;
        }
        
        document.querySelectorAll('.form-grid').forEach(b => b.classList.add('hidden'));
        document.getElementById('block-historial').classList.add('hidden');
        document.getElementById('block-monto').classList.remove('hidden');
        document.getElementById('btn-guardar').style.display='block';

        // OFICINA Y CAMPO COMPARTEN EL MISMO BLOQUE VISUAL PERO LOGICA DISTINTA
        if(MODO=='OFICINA' || MODO=='CAMPO') document.getElementById('block-depositos').classList.remove('hidden');
        else if(MODO=='CONTADO') document.getElementById('block-contado').classList.remove('hidden');
        else if(MODO=='ABONOS') document.getElementById('block-abonos').classList.remove('hidden');
        else if(MODO=='FALTANTES') document.getElementById('block-faltantes').classList.remove('hidden');
        else if(MODO=='EXCEDENTE') document.getElementById('block-excedente').classList.remove('hidden');
        else { 
            ES_HISTORIAL = true;
            document.getElementById('block-historial').classList.remove('hidden');
            document.getElementById('block-monto').classList.add('hidden');
            document.getElementById('btn-guardar').style.display='none';
            return;
        }

        ES_HISTORIAL = false;
        FILTRO = HOY;
        document.getElementById('titulo-reporte').innerText = "REPORTE DE HOY ("+HOY+")";
        pintar();
        
        const btn = document.getElementById('btn-guardar');
        btn.className = `btn-${MODO.toLowerCase()}`;
        btn.innerText = ID_EDIT ? "ACTUALIZAR" : `GUARDAR ${MODO}`;
    }

    window.buscarHistorial = function() {
        FILTRO = document.getElementById('fecha_historial').value;
        document.getElementById('titulo-reporte').innerText = "REPORTE DEL: " + FILTRO;
        pintar();
    };

    window.guardar = function() {
        try {
            const fecha = document.getElementById('fecha').value;
            const monto = parseFloat(document.getElementById('monto').value);
            if(!monto || isNaN(monto)) return alert("Falta monto v√°lido");

            let obj={ fecha:fecha, fecha_registro:HOY, monto:monto };
            let ruta = '';

            let modoGuardado = ID_EDIT ? obtenerModoDesdeRuta(RUTA_EDIT) : MODO;
            
            if(!ID_EDIT) {
                if(MODO=='CONTADO') ruta='ventas_contado';
                else if(MODO=='ABONOS') ruta='abonos_clientes';
                else if(MODO=='FALTANTES') ruta='faltantes_cobro';
                else if(MODO=='EXCEDENTE') ruta='excedente_tarjetas';
                else ruta='registros_milagro'; // CAMPO Y OFICINA VAN AQUI
            } else {
                ruta = RUTA_EDIT;
            }

            if(ruta=='ventas_contado') {
                obj.vendedor = document.getElementById('vendedor').value;
                obj.cuenta = document.getElementById('contado_cuenta').value;
                obj.articulo = document.getElementById('articulo_contado').value;
            } else if(ruta=='abonos_clientes') {
                obj.tarjeta = document.getElementById('abono_tarjeta').value;
                obj.articulo = document.getElementById('abono_articulo').value;
                obj.saldo_restante = document.getElementById('abono_saldo').value;
                obj.cuenta = document.getElementById('abono_cuenta').value;
            } else if(ruta=='faltantes_cobro') {
                obj.cobrador = document.getElementById('fal_cobrador').value;
                obj.zona = document.getElementById('fal_zona').value;
            } else if(ruta=='excedente_tarjetas') {
                obj.tarjeta = document.getElementById('exc_tarjeta').value;
                obj.articulo = document.getElementById('exc_articulo').value;
                obj.cuenta = document.getElementById('exc_cuenta').value;
            } else { // DEPOSITOS (OFICINA O CAMPO)
                // Si estoy editando, preservo el origen original, sino uso el modo actual
                if(ID_EDIT) {
                    let registroOriginal = datos.dep.find(r => r.id === ID_EDIT);
                    obj.origen = registroOriginal ? registroOriginal.origen : MODO;
                } else {
                    obj.origen = MODO; // 'OFICINA' o 'CAMPO'
                }
                
                obj.semana = document.getElementById('semana').value;
                obj.ref = document.getElementById('ref').value;
                obj.zona = document.getElementById('zona').value;
                obj.cobrador = document.getElementById('cobrador').value;
                obj.cuenta = document.getElementById('cuenta').value;
            }

            if(ID_EDIT) {
                db.ref(`${ruta}/${ID_EDIT}`).update(obj)
                .then(()=>{ alert("‚úÖ Actualizado Correctamente"); cancelarEdicion(); })
                .catch(e => alert("Error: " + e.message));
            } else {
                db.ref(ruta).push(obj)
                .then(()=>{ alert("‚úÖ Guardado Correctamente"); cancelarEdicion(); })
                .catch(e => alert("Error: " + e.message));
            }
        } catch(e) { alert("Error critico: " + e); }
    };

    function obtenerModoDesdeRuta(ruta) {
        if(ruta=='ventas_contado') return 'CONTADO';
        if(ruta=='abonos_clientes') return 'ABONOS';
        if(ruta=='faltantes_cobro') return 'FALTANTES';
        if(ruta=='excedente_tarjetas') return 'EXCEDENTE';
        return 'CAMPO'; // Por defecto, se ajusta en iniciarEdicion
    }

    const sumar = (a, b) => Math.round((a + b) * 100) / 100;
    const fmt = (num) => "L. " + num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    function pintar() {
        const div = document.getElementById('reportes');
        div.innerHTML = "";
        let total = 0;
        
        const filtrar = (arr) => arr.filter(i => (i.fecha_registro || i.fecha) === FILTRO);

        // 1. EXCEDENTES
        let exc = filtrar(datos.exc);
        if(exc.length){
            let sub = exc.reduce((a,b)=> sumar(a, parseFloat(b.monto)||0), 0);
            total = sumar(total, sub);
            let h = `<div class="report-section border-david"><h3 class="account-title">EXCEDENTES <span>${fmt(sub)}</span></h3><table>`;
            exc.forEach(r => { h+=`<tr><td>${r.fecha}</td><td>#${r.tarjeta}</td><td>${r.articulo}</td><td>(${r.cuenta})</td><td>${fmt(r.monto)}</td><td class="no-print"><button class="btn-action btn-edit" onclick="iniciarEdicion('${r.id}','excedente_tarjetas')">‚úèÔ∏è</button><button class="btn-action btn-del" onclick="del('${r.id}','excedente_tarjetas')">üóëÔ∏è</button></td></tr>`; });
            div.innerHTML += h+"</table></div>";
        }

        // 2. FALTANTES
        let fal = filtrar(datos.fal);
        if(fal.length){
            let sub = fal.reduce((a,b)=> sumar(a, parseFloat(b.monto)||0), 0);
            total = sumar(total, sub);
            let h = `<div class="report-section border-faltantes"><h3 class="account-title">FALTANTES <span>${fmt(sub)}</span></h3><table>`;
            fal.forEach(r => { h+=`<tr><td>${r.fecha}</td><td>${r.cobrador}<br>${r.zona}</td><td>${fmt(r.monto)}</td><td class="no-print"><button class="btn-action btn-edit" onclick="iniciarEdicion('${r.id}','faltantes_cobro')">‚úèÔ∏è</button><button class="btn-action btn-del" onclick="del('${r.id}','faltantes_cobro')">üóëÔ∏è</button></td></tr>`; });
            div.innerHTML += h+"</table></div>";
        }

        // 3. ABONOS
        let abo = filtrar(datos.abo);
        if(abo.length){
            let sub = abo.reduce((a,b)=> sumar(a, parseFloat(b.monto)||0), 0);
            total = sumar(total, sub);
            let h = `<div class="report-section border-abonos"><h3 class="account-title">ABONOS <span>${fmt(sub)}</span></h3><table>`;
            abo.forEach(r => { h+=`<tr><td>${r.fecha}</td><td>#${r.tarjeta}<br>${r.articulo}</td><td>(${r.cuenta})</td><td>${fmt(r.monto)}</td><td class="no-print"><button class="btn-action btn-edit" onclick="iniciarEdicion('${r.id}','abonos_clientes')">‚úèÔ∏è</button><button class="btn-action btn-del" onclick="del('${r.id}','abonos_clientes')">üóëÔ∏è</button></td></tr>`; });
            div.innerHTML += h+"</table></div>";
        }

        // 4. CONTADO
        let con = filtrar(datos.con);
        if(con.length){
            let sub = con.reduce((a,b)=> sumar(a, parseFloat(b.monto)||0), 0);
            total = sumar(total, sub);
            let h = `<div class="report-section border-mix"><h3 class="account-title">CONTADO <span>${fmt(sub)}</span></h3><table>`;
            con.forEach(r => { h+=`<tr><td>${r.fecha}</td><td>${r.vendedor}<br>${r.articulo}</td><td>(${r.cuenta})</td><td>${fmt(r.monto)}</td><td class="no-print"><button class="btn-action btn-edit" onclick="iniciarEdicion('${r.id}','ventas_contado')">‚úèÔ∏è</button><button class="btn-action btn-del" onclick="del('${r.id}','ventas_contado')">üóëÔ∏è</button></td></tr>`; });
            div.innerHTML += h+"</table></div>";
        }

        // 5. DEPOSITOS (OFICINA Y CAMPO JUNTOS PERO DIFERENCIADOS)
        let dep = filtrar(datos.dep);
        for(let c in cuentas) {
            let list = dep.filter(r => r.cuenta === c);
            if(list.length) {
                let sub = list.reduce((a,b)=> sumar(a, parseFloat(b.monto)||0), 0);
                total = sumar(total, sub);
                let resumen = {};
                let h = `<div class="report-section ${cuentas[c]}"><h3 class="account-title">${c} <span>${fmt(sub)}</span></h3><table>`;
                
                list.forEach(r => { 
                    let m = parseFloat(r.monto) || 0;
                    if(!resumen[r.zona]) resumen[r.zona]=0; 
                    resumen[r.zona] = sumar(resumen[r.zona], m);
                    
                    // BADGE PARA SABER SI ES OFICINA O CAMPO
                    let badge = r.origen === 'OFICINA' ? '<span class="badge bg-oficina">OFI</span>' : '<span class="badge bg-campo">CAM</span>';
                    
                    h+=`<tr><td>${badge} ${r.fecha}</td><td>${r.zona}<br>Ref:${r.ref}</td><td>${fmt(m)}</td><td class="no-print"><button class="btn-action btn-edit" onclick="iniciarEdicion('${r.id}','registros_milagro')">‚úèÔ∏è</button><button class="btn-action btn-del" onclick="del('${r.id}','registros_milagro')">üóëÔ∏è</button></td></tr>`; 
                });
                
                h += "</table><div class='zone-summary'><b>Resumen por Zona:</b>";
                for(let z in resumen) h+=`<div class='zone-row'><span>${z}</span><span>${fmt(resumen[z])}</span></div>`;
                h += "</div></div>";
                div.innerHTML += h;
            }
        }

        document.getElementById('gran-total').innerText = fmt(total);
        if(total==0 && exc.length==0 && fal.length==0 && abo.length==0 && con.length==0 && dep.length==0) div.innerHTML = "<p>Nada ingresado para esta fecha.</p>";
    }

    // --- ACCIONES ---
    window.del = (id, ruta) => { if(confirm("¬øEliminar registro?")) db.ref(`${ruta}/${id}`).remove(); };
    
    window.cancelarEdicion = () => { 
        ID_EDIT=null; 
        RUTA_EDIT=null;
        document.querySelectorAll('input').forEach(i=>i.value=''); 
        document.getElementById('btn-cancelar').style.display='none';
        document.getElementById('fecha').value = HOY; 
        
        actualizarUI();
    };

    window.iniciarEdicion = (id, ruta) => {
        ID_EDIT = id;
        RUTA_EDIT = ruta;
        
        let tipo = '';
        
        // Logica para saber si es Oficina o Campo al editar
        if(ruta === 'registros_milagro') {
            let reg = datos.dep.find(x => x.id === id);
            tipo = reg ? reg.origen : 'CAMPO'; // Si es OFICINA, detecta OFICINA
        } else {
            tipo = obtenerModoDesdeRuta(ruta);
        }
        
        MODO = tipo;
        
        // Cargar vista
        actualizarUI();
        document.getElementById('btn-cancelar').style.display='block';
        window.scrollTo(0,0);

        // Llenar datos
        let r;
        if(tipo === 'OFICINA' || tipo === 'CAMPO') {
            r = datos.dep.find(x => x.id === id);
            document.getElementById('semana').value = r.semana;
            document.getElementById('ref').value = r.ref;
            document.getElementById('zona').value = r.zona;
            autoCobrador(); 
            document.getElementById('cuenta').value = r.cuenta;
        } 
        else if(tipo === 'CONTADO') {
            r = datos.con.find(x => x.id === id);
            document.getElementById('vendedor').value = r.vendedor;
            document.getElementById('contado_cuenta').value = r.cuenta;
            document.getElementById('articulo_contado').value = r.articulo;
        }
        else if(tipo === 'ABONOS') {
            r = datos.abo.find(x => x.id === id);
            document.getElementById('abono_tarjeta').value = r.tarjeta;
            document.getElementById('abono_articulo').value = r.articulo;
            document.getElementById('abono_saldo').value = r.saldo_restante;
            document.getElementById('abono_cuenta').value = r.cuenta;
        }
        else if(tipo === 'FALTANTES') {
            r = datos.fal.find(x => x.id === id);
            document.getElementById('fal_cobrador').value = r.cobrador;
            zonaFaltante(); 
            document.getElementById('fal_zona').value = r.zona;
        }
        else if(tipo === 'EXCEDENTE') {
            r = datos.exc.find(x => x.id === id);
            document.getElementById('exc_tarjeta').value = r.tarjeta;
            document.getElementById('exc_articulo').value = r.articulo;
            document.getElementById('exc_cuenta').value = r.cuenta;
        }

        if(r) {
            document.getElementById('fecha').value = r.fecha;
            document.getElementById('monto').value = r.monto;
        }
    };

    function llenarZonas() {
        const sel = document.getElementById('zona');
        for (const [k, v] of Object.entries(rutas)) {
            let g = document.createElement('optgroup'); g.label=k;
            v.forEach(z => { let o=document.createElement('option'); o.value=z; o.innerText=z; o.setAttribute('data-c',k); g.appendChild(o); });
            sel.appendChild(g);
        }
    }
    window.autoCobrador = () => document.getElementById('cobrador').value = document.getElementById('zona').options[document.getElementById('zona').selectedIndex].getAttribute('data-c');
    
    window.zonaFaltante = () => {
        let c = document.getElementById('fal_cobrador').value;
        let s = document.getElementById('fal_zona'); s.innerHTML="";
        if(rutas[c]) rutas[c].forEach(z => { let o=document.createElement('option'); o.value=z; o.innerText=z; s.appendChild(o); });
    };
</script>
</body>
</html>
