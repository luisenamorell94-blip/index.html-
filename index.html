<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comercial GYG - Sistema Final</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { 
            --primary: #004d40; --field: #e65100; --contado: #4a148c;
            --abonos: #1565c0; --faltante: #c62828; --excedente: #00838f; --historial: #455a64;
        }
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 10px; padding-bottom: 80px; }
        
        /* HEADER */
        header { background: var(--primary); color: white; padding: 10px; text-align: center; border-radius: 0 0 8px 8px; margin-bottom: 15px; }
        
        /* PESTAÑAS */
        .tabs { display: flex; gap: 5px; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .tab { flex: 1; min-width: 90px; padding: 12px; text-align: center; font-weight: bold; background: #ccc; color: #555; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.8rem; }
        
        .active-oficina { background: white; color: var(--primary); border-bottom: 4px solid var(--primary); }
        .active-campo { background: white; color: var(--field); border-bottom: 4px solid var(--field); }
        .active-contado { background: white; color: var(--contado); border-bottom: 4px solid var(--contado); }
        .active-abonos { background: white; color: var(--abonos); border-bottom: 4px solid var(--abonos); }
        .active-faltantes { background: white; color: var(--faltante); border-bottom: 4px solid var(--faltante); }
        .active-excedente { background: white; color: var(--excedente); border-bottom: 4px solid var(--excedente); }
        .active-historial { background: white; color: var(--historial); border-bottom: 4px solid var(--historial); }

        /* FORMULARIO */
        .card { background: white; padding: 15px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full { grid-column: span 2; }
        
        label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; margin-top: 8px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* BOTONES */
        button { width: 100%; padding: 15px; border: none; border-radius: 5px; font-weight: bold; color: white; cursor: pointer; margin-top: 15px; font-size: 1rem; }
        .btn-oficina { background: var(--primary); }
        .btn-campo { background: var(--field); }
        .btn-contado { background: var(--contado); }
        .btn-abonos { background: var(--abonos); }
        .btn-faltantes { background: var(--faltante); }
        .btn-excedente { background: var(--excedente); }
        .btn-historial { background: var(--historial); }
        .btn-cancelar { background: #666; display: none; }
        .btn-pdf { background: #d32f2f; margin-top: 20px; }

        /* REPORTES */
        #area-impresion { margin-top: 20px; }
        .report-section { background: white; border-radius: 8px; padding: 10px; margin-bottom: 15px; border-top: 5px solid #555; }
        
        .border-david { border-top-color: #1565c0; }
        .border-lesly { border-top-color: #ad1457; }
        .border-mix { border-top-color: #6a1b9a; }
        .border-jose { border-top-color: #2e7d32; }
        .border-abonos { border-top-color: #1565c0; }
        .border-faltantes { border-top-color: #c62828; }
        
        /* ESTILO DEL TITULO CON TOTAL A LA DERECHA */
        .account-title { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin: 0 0 10px 0; 
            padding-bottom: 5px; 
            border-bottom: 1px solid #eee; 
            font-size: 1rem; 
            color: #333; 
        }
        .account-title span { font-weight: bold; font-size: 1.1rem; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 5px; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f5f5f5; }
        
        /* RESUMEN ZONA */
        .zone-summary { background: #f9f9f9; padding: 10px; margin-top: 10px; font-size: 0.85rem; border-radius: 4px; border: 1px dashed #ccc; }
        .zone-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px dotted #ddd; }
        .zone-row:last-child { border-bottom: none; }

        .total-box { background: #333; color: white; padding: 10px; text-align: right; font-weight: bold; font-size: 1.2rem; }
        .hidden { display: none; }

        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<header class="no-print"><h2>SISTEMA GYG</h2></header>

<div class="container" style="max-width:900px; margin:0 auto;">

    <div class="tabs no-print">
        <div id="tab-oficina" class="tab active-oficina" onclick="cambiar('OFICINA')">OFICINA</div>
        <div id="tab-campo" class="tab" onclick="cambiar('CAMPO')">CAMPO</div>
        <div id="tab-contado" class="tab" onclick="cambiar('CONTADO')">CONTADO</div>
        <div id="tab-abonos" class="tab" onclick="cambiar('ABONOS')">ABONOS</div>
        <div id="tab-faltantes" class="tab" onclick="cambiar('FALTANTES')">FALTANTES</div>
        <div id="tab-excedente" class="tab" onclick="cambiar('EXCEDENTE')">EXCEDENTE</div>
        <div id="tab-historial" class="tab" onclick="cambiar('HISTORIAL')">HISTORIAL</div>
    </div>

    <div class="card no-print">
        <div class="full">
            <label>Fecha del Recibo:</label>
            <input type="date" id="fecha">
            <small style="color:#004d40">ℹ️ Se guardará en el reporte de HOY (Carga diaria).</small>
        </div>

        <div id="block-depositos" class="form-grid">
            <div><label>Semana:</label><select id="semana"><option>Semana 1</option><option>Semana 2</option><option>Semana 3</option><option>Semana 4</option><option>Semana 5</option></select></div>
            <div><label>Referencia:</label><input type="number" id="ref"></div>
            <div class="full"><label>Zona:</label><select id="zona" onchange="autoCobrador()"></select></div>
            <div class="full"><label>Cobrador:</label><input type="text" id="cobrador" readonly style="background:#eee;"></div>
            <div class="full"><label>Cuenta:</label><select id="cuenta"></select></div>
        </div>

        <div id="block-contado" class="form-grid hidden">
            <div><label>Vendedor:</label>
                <select id="vendedor">
                    <option>SANTOS</option><option>NOE</option><option>CARLOS</option>
                    <option>RAMON</option><option>ORLANDO</option><option>DAVID</option>
                </select>
            </div>
            <div><label>Cuenta Destino:</label>
                <select id="contado_cuenta">
                    <option value="DAVID">CUENTA DAVID</option>
                    <option value="LESLY">CUENTA LESLY</option>
                    <option value="DAVID_LESLY">DAVID (VIA LESLY)</option>
                    <option value="JOSE_RODINDER">JOSE RODINDER</option>
                </select>
            </div>
            <div class="full"><label>Artículo:</label><input type="text" id="articulo_contado"></div>
        </div>

        <div id="block-abonos" class="form-grid hidden">
            <div><label>Tarjeta:</label><input type="text" id="abono_tarjeta"></div>
            <div><label>Artículo:</label><input type="text" id="abono_articulo"></div>
            <div><label>Saldo:</label><input type="number" id="abono_saldo"></div>
            <div><label>Cuenta Destino:</label>
                <select id="abono_cuenta">
                    <option value="DAVID">CUENTA DAVID</option>
                    <option value="LESLY">CUENTA LESLY</option>
                    <option value="DAVID_LESLY">DAVID (VIA LESLY)</option>
                    <option value="JOSE_RODINDER">JOSE RODINDER</option>
                </select>
            </div>
        </div>

        <div id="block-faltantes" class="form-grid hidden">
            <div class="full"><label>Cobrador:</label>
                <select id="fal_cobrador" onchange="zonaFaltante()">
                    <option value="">-- Seleccione --</option>
                    <option value="MIGUEL">MIGUEL</option><option value="ANGEL">ANGEL</option>
                    <option value="FERNANDO">FERNANDO</option><option value="AMALET">AMALET</option><option value="JORGE">JORGE</option>
                </select>
            </div>
            <div class="full"><label>Zona:</label><select id="fal_zona"></select></div>
        </div>

        <div id="block-excedente" class="form-grid hidden">
            <div><label>Tarjeta:</label><input type="text" id="exc_tarjeta"></div>
            <div><label>Artículo:</label><input type="text" id="exc_articulo"></div>
            <div class="full"><label>Cuenta:</label><input value="LESLY" readonly></div>
        </div>

        <div id="block-historial" class="hidden" style="text-align:center;">
            <h3>BUSCAR REPORTE ANTIGUO</h3>
            <p>Selecciona el día que hiciste la carga:</p>
            <input type="date" id="fecha_historial" style="max-width:200px; margin:10px auto;">
            <button class="btn-historial" onclick="buscarHistorial()">BUSCAR</button>
        </div>

        <div id="block-monto" class="full">
            <label>Monto (L.):</label>
            <input type="number" id="monto" style="font-size:1.2rem; font-weight:bold;">
        </div>

        <button id="btn-guardar" class="btn-oficina" onclick="guardar()">GUARDAR</button>
        <button id="btn-cancelar" class="btn-cancelar" onclick="cancelar()">CANCELAR</button>
    </div>

    <div id="area-impresion">
        <h3 id="titulo-reporte" class="no-print">REPORTE DE HOY</h3>
        <div id="reportes"></div>
        <div class="total-box">TOTAL: <span id="gran-total">L. 0.00</span></div>
    </div>

    <button class="btn-pdf no-print" onclick="window.print()">IMPRIMIR PDF</button>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAYJRmMQbV-j6hGfHCZyuCgtvmkY0C2L1g", authDomain: "ingreso-depositos.firebaseapp.com", databaseURL: "https://ingreso-depositos-default-rtdb.firebaseio.com", projectId: "ingreso-depositos", storageBucket: "ingreso-depositos.firebasestorage.app", messagingSenderId: "788432921819", appId: "1:788432921819:web:b5f792eecbe4b7b00498fe" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let MODO = 'OFICINA';
    let ID_EDIT = null;
    let HOY = new Date().toISOString().split('T')[0];
    let FILTRO = HOY;
    let ES_HISTORIAL = false;

    let datos = { dep:[], con:[], abo:[], fal:[], exc:[] };
    
    // LISTAS COMPLETAS RESTAURADAS
    const rutas = { 
        "MIGUEL": ["Elixir","Saba Olanchito", "Zona Saba"], 
        "ANGEL": ["Margen Izquierda","Saba Tocoa"], 
        "FERNANDO": ["Vicinia","Trujillo", "Honduras Aguan"], 
        "AMALET": ["Balfate","Bonito Oriental"], 
        "JORGE": ["Planes","Jutiapa", "Sonaguera", "Faust"] 
    };
    const cuentas = { "DAVID":"border-david", "LESLY":"border-lesly", "DAVID_LESLY":"border-mix", "JOSE_RODINDER":"border-jose" };

    window.onload = function() {
        document.getElementById('fecha').value = HOY;
        document.getElementById('fecha_historial').value = HOY;
        llenarZonas();
        
        // CARGAR DATOS
        db.ref('registros_milagro').on('value', s => { datos.dep=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.dep.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('ventas_contado').on('value', s => { datos.con=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.con.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('abonos_clientes').on('value', s => { datos.abo=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.abo.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('faltantes_cobro').on('value', s => { datos.fal=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.fal.push({id:k,...s.val()[k]})); pintar(); });
        db.ref('excedente_tarjetas').on('value', s => { datos.exc=[]; if(s.val()) Object.keys(s.val()).forEach(k=>datos.exc.push({id:k,...s.val()[k]})); pintar(); });
    };

    window.cambiar = function(m) {
        MODO = m; cancelar();
        // UI
        document.querySelectorAll('.tab').forEach(t => t.className='tab');
        document.getElementById('tab-'+m.toLowerCase()).className = `tab active-${m.toLowerCase()}`;
        
        document.querySelectorAll('.form-grid').forEach(b => b.classList.add('hidden'));
        document.getElementById('block-historial').classList.add('hidden');
        document.getElementById('block-monto').classList.remove('hidden');
        document.getElementById('btn-guardar').style.display='block';

        if(m=='OFICINA' || m=='CAMPO') document.getElementById('block-depositos').classList.remove('hidden');
        else if(m=='CONTADO') document.getElementById('block-contado').classList.remove('hidden');
        else if(m=='ABONOS') document.getElementById('block-abonos').classList.remove('hidden');
        else if(m=='FALTANTES') document.getElementById('block-faltantes').classList.remove('hidden');
        else if(m=='EXCEDENTE') document.getElementById('block-excedente').classList.remove('hidden');
        else { // HISTORIAL
            ES_HISTORIAL = true;
            document.getElementById('block-historial').classList.remove('hidden');
            document.getElementById('block-monto').classList.add('hidden');
            document.getElementById('btn-guardar').style.display='none';
            return;
        }

        ES_HISTORIAL = false;
        FILTRO = HOY;
        document.getElementById('titulo-reporte').innerText = "REPORTE DE HOY ("+HOY+")";
        pintar();
        
        const btn = document.getElementById('btn-guardar');
        btn.className = `btn-${m.toLowerCase()}`;
        btn.innerText = `GUARDAR ${m}`;
        
        if(m=='OFICINA') document.getElementById('cuenta').innerHTML="<option value='LESLY'>CUENTA LESLY</option>";
        else document.getElementById('cuenta').innerHTML="<option value='DAVID'>CUENTA DAVID</option><option value='DAVID_LESLY'>DAVID (VIA LESLY)</option><option value='JOSE_RODINDER'>JOSE RODINDER</option>";
    };

    window.buscarHistorial = function() {
        FILTRO = document.getElementById('fecha_historial').value;
        document.getElementById('titulo-reporte').innerText = "REPORTE DEL: " + FILTRO;
        pintar();
    };

    window.guardar = function() {
        const fecha = document.getElementById('fecha').value;
        const monto = parseFloat(document.getElementById('monto').value);
        if(!monto) return alert("Falta monto");

        let ruta='', obj={ fecha:fecha, fecha_registro:HOY, monto:monto };

        if(MODO=='CONTADO') {
            obj.vendedor = document.getElementById('vendedor').value;
            obj.cuenta = document.getElementById('contado_cuenta').value;
            obj.articulo = document.getElementById('articulo_contado').value;
            ruta='ventas_contado';
        } else if(MODO=='ABONOS') {
            obj.tarjeta = document.getElementById('abono_tarjeta').value;
            obj.articulo = document.getElementById('abono_articulo').value;
            obj.saldo_restante = document.getElementById('abono_saldo').value;
            obj.cuenta = document.getElementById('abono_cuenta').value;
            ruta='abonos_clientes';
        } else if(MODO=='FALTANTES') {
            obj.cobrador = document.getElementById('fal_cobrador').value;
            obj.zona = document.getElementById('fal_zona').value;
            ruta='faltantes_cobro';
        } else if(MODO=='EXCEDENTE') {
            obj.tarjeta = document.getElementById('exc_tarjeta').value;
            obj.articulo = document.getElementById('exc_articulo').value;
            obj.cuenta = 'LESLY';
            ruta='excedente_tarjetas';
        } else { 
            obj.origen = MODO;
            obj.semana = document.getElementById('semana').value;
            obj.ref = document.getElementById('ref').value;
            obj.zona = document.getElementById('zona').value;
            obj.cobrador = document.getElementById('cobrador').value;
            obj.cuenta = document.getElementById('cuenta').value;
            ruta='registros_milagro';
        }

        if(ID_EDIT) db.ref(`${ruta}/${ID_EDIT}`).update(obj).then(()=>{ alert("Editado"); cancelar(); });
        else db.ref(ruta).push(obj).then(()=>{ alert("Guardado"); cancelar(); });
    };

    function pintar() {
        const div = document.getElementById('reportes');
        div.innerHTML = "";
        let total = 0;
        
        const filtrar = (arr) => arr.filter(i => (i.fecha_registro || i.fecha) === FILTRO);

        // 1. EXCEDENTES
        let exc = filtrar(datos.exc);
        if(exc.length){
            let sub = exc.reduce((a,b)=>a+b.monto,0); total+=sub;
            let h = `<div class="report-section border-lesly"><h3 class="account-title">EXCEDENTES <span>L. ${sub.toLocaleString()}</span></h3><table>`;
            exc.forEach(r => { h+=`<tr><td>${r.fecha}</td><td>#${r.tarjeta}</td><td>${r.articulo}</td><td>L. ${r.monto}</td><td class="no-print"><button onclick="del('${r.id}','excedente_tarjetas')">X</button></td></tr>`; });
            div.innerHTML += h+"</table></div>";
        }

        // 2. FALTANTES
        let fal = filtrar(datos.fal);
        if(fal.length){
            let sub = fal.reduce((a,b)=>a+b.monto,0); total+=sub;
            let h = `<div class="report-section border-faltantes"><h3 class="account-title">FALTANTES <span>L. ${sub.toLocaleString()}</span></h3><table>`;
            fal.forEach(r => { h+=`<tr><td>${r.fecha}</td><td>${r.cobrador}<br>${r.zona}</td><td>L. ${r.monto}</td><td class="no-print"><button onclick="del('${r.id}','faltantes_cobro')">X</button></td></tr>`; });
            div.innerHTML += h+"</table></div>";
        }

        // 3. ABONOS
        let abo = filtrar(datos.abo);
        if(abo.length){
            let sub = abo.reduce((a,b)=>a+b.monto,0); total+=sub;
            let h = `<div class="report-section border-abonos"><h3 class="account-title">ABONOS <span>L. ${sub.toLocaleString()}</span></h3><table>`;
            abo.forEach(r => { h+=`<tr><td>${r.fecha}</td><td>#${r.tarjeta}<br>${r.articulo}</td><td>(${r.cuenta})</td><td>L. ${r.monto}</td><td class="no-print"><button onclick="del('${r.id}','abonos_clientes')">X</button></td></tr>`; });
            div.innerHTML += h+"</table></div>";
        }

        // 4. CONTADO
        let con = filtrar(datos.con);
        if(con.length){
            let sub = con.reduce((a,b)=>a+b.monto,0); total+=sub;
            let h = `<div class="report-section border-mix"><h3 class="account-title">CONTADO <span>L. ${sub.toLocaleString()}</span></h3><table>`;
            con.forEach(r => { h+=`<tr><td>${r.fecha}</td><td>${r.vendedor}<br>${r.articulo}</td><td>(${r.cuenta})</td><td>L. ${r.monto}</td><td class="no-print"><button onclick="del('${r.id}','ventas_contado')">X</button></td></tr>`; });
            div.innerHTML += h+"</table></div>";
        }

        // 5. DEPOSITOS (CON TOTAL ARRIBA Y RESUMEN ZONA ABAJO)
        let dep = filtrar(datos.dep);
        for(let c in cuentas) {
            let list = dep.filter(r => r.cuenta === c);
            if(list.length) {
                let sub = list.reduce((a,b)=>a+b.monto,0); total+=sub;
                let resumen = {};
                let h = `<div class="report-section ${cuentas[c]}"><h3 class="account-title">${c} <span>L. ${sub.toLocaleString()}</span></h3><table>`;
                
                list.forEach(r => { 
                    if(!resumen[r.zona]) resumen[r.zona]=0; resumen[r.zona]+=r.monto;
                    h+=`<tr><td>${r.fecha}</td><td>${r.zona}<br>Ref:${r.ref}</td><td>L. ${r.monto}</td><td class="no-print"><button onclick="del('${r.id}','registros_milagro')">X</button></td></tr>`; 
                });
                
                h += "</table><div class='zone-summary'><b>Resumen por Zona:</b>";
                for(let z in resumen) h+=`<div class='zone-row'><span>${z}</span><span>L. ${resumen[z].toLocaleString()}</span></div>`;
                h += "</div></div>";
                div.innerHTML += h;
            }
        }

        document.getElementById('gran-total').innerText = "L. " + total.toLocaleString();
        if(total==0) div.innerHTML = "<p>Nada ingresado para esta fecha.</p>";
    }

    window.del = (id, ruta) => { if(confirm("Borrar?")) db.ref(`${ruta}/${id}`).remove(); };
    window.cancelar = () => { 
        ID_EDIT=null; 
        document.querySelectorAll('input').forEach(i=>i.value=''); 
        document.getElementById('btn-cancelar').style.display='none';
    };

    function llenarZonas() {
        const sel = document.getElementById('zona');
        for (const [k, v] of Object.entries(rutas)) {
            let g = document.createElement('optgroup'); g.label=k;
            v.forEach(z => { let o=document.createElement('option'); o.value=z; o.innerText=z; o.setAttribute('data-c',k); g.appendChild(o); });
            sel.appendChild(g);
        }
    }
    window.autoCobrador = () => document.getElementById('cobrador').value = document.getElementById('zona').options[document.getElementById('zona').selectedIndex].getAttribute('data-c');
    
    window.zonaFaltante = () => {
        let c = document.getElementById('fal_cobrador').value;
        let s = document.getElementById('fal_zona'); s.innerHTML="";
        if(rutas[c]) rutas[c].forEach(z => { let o=document.createElement('option'); o.value=z; o.innerText=z; s.appendChild(o); });
    };
</script>
</body>
</html>
